# （一）Ajax 基础

## 1. Ajax 基础

### 1.1 传统网站中存在的问题

- 网速慢的情况下，页面加载时间长，用户只能等待
- 表单提交后，如果一项内容不合格，需要重新填写所有表单内容
- 页面跳转，重新加载页面，造成资源浪费，增加用户等待时间

### 1.2 Ajax 概述

Ajax：标准读音 [ˈeɪˌdʒæks] ，中文音译：阿贾克斯。  
它是浏览器提供的一套方法，可以实现 **页面无刷新更新数据，提高用户浏览网站应用的体验**。

### 1.3 Ajax 应用场景

- 页面上拉加载更多数据
- 列表数据无刷新分页
- 表单项离开焦点数据验证
- 搜索框提示文字下拉列表
- ...

### 1.4 Ajax 运行环境

Ajax 技术需要 **运行在网站服务器环境中才能生效**，我们学习 Ajax 可以使用 Node 创建的服务器作为网站服务器。

## 2. Ajax 运行原理及实现

### 2.1 Ajax 运行原理

Ajax 相当于浏览器 **发送请求与接收响应的代理人**，以实现在不影响用户浏览页面的情况下，局部更新页面数据，从而提高用户体验。

![ajax1](https://cdn.jsdelivr.net/gh/Hacker-C/Picture-Bed@main/JavaScript/ajax1.34wif6pbt020.png)

### 2.2 Ajax 实现步骤

1. 创建 Ajax 对象  
    使用 `XMLHttpRequest` 构造函数实例化创建一个 `xhr`（“小黄人”）。
    ```js
    var xhr = new XMLHttpRequest();
    ```

2. 告诉 Ajax 请求方式和请求地址  
    以何种方式发送请求，向哪发送请求。
    ```js
    xhr.open('get', 'http://www.example.com');
    ```

3. 发送请求
    ```js
    xhr.send();
    ```

4. 获取服务器端给与客户端的响应数据  
    响应受到网络环境的影响，发送请求以后不能直接去接收数据（例如网络拥挤导致服务器延迟响应），而是要使用 `onload` 方法监听服务器的响应状态。`responseText` 是服务器响应的数据内容。
    ```js
    xhr.onload = function () {
        console.log(xhr.responseText);
    }
    ```

### 2.3 服务器端响应的数据格式

在真实的项目中，服务器端 **大多数情况下会以 JSON 对象作为响应数据的格式**。当客户端拿到响应数据时，要将 JSON 数据和 HTML 字符串进行拼接，然后将拼接的结果展示在页面中。  

在 http 请求与响应的过程中，无论是请求参数还是响应内容，如果是对象类型，最终都会被转换为对象字符串进行传输。我们往往使用 `JSON.parse()` 方法将该对象字符串转换为对象。

将 json 字符串转换为json对象：
```js
JSON.parse()
```

### 2.4 请求参数传递

传统网站表单提交
```html
 <form method="get" action="http://www.example.com">
     <input type="text" name="username"/>
     <input type="password" name="password">
 </form>
 <!-- http://www.example.com?username=zhangsan&password=123456 -->
```

- GET 请求方式  
    get 请求方式需要手动拼接请求参数：
    ```js
    let params = 'username=' + nameValue + '&age=' + ageValue;
    xhr.open('get', params);
    xhr.open('get', 'http://www.example.com?' + params);
    // xhr.open('get', 'http://www.example.com?username=zhangsan&age=20');
    ```
    服务端（这里以 node express 构建的服务器为例）使用 `req.query` 来接收客户端传来的请求参数，返回一个对象
    ```js
    // app.js
    app.get('/get', (req, res) => {
        res.send(req.query);
    })
    ```

- POST 请求方式
    ```js
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    xhr.send('name=zhangsan&age=20');
    ```
    举例：
    ```js
    // 拼接参数
    let params = 'username=' + nameValue + '&age=' + ageValue;
    // 设置post请求
    xhr.open('post', 'http://localhost:3001/post');
    // 设置请求参数格式的类型（post方式必须设置）
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    // post请求的参数写在 send 方法里面
    xhr.send(params);
    xhr.onload = function () {
        console.log(xhr.responseText);
    }
    ```
    node 服务器 app.js 中：
    ```js
    // app.js
    // post 方式获取请求参数
    app.use(express.urlencoded());
    app.post('/post', (req, res) => {
        // body 请求体
        res.send(req.body);
    })
    ```

### 2.5 请求报文

在 HTTP 请求和响应的过程中传递的数据块就叫报文，包括要传送的数据和一些附加信息，这些数据和信息要遵守规定好的格式。
![ajax2](https://cdn.jsdelivr.net/gh/Hacker-C/Picture-Bed@main/JavaScript/ajax2.2ngwh6y398q0.png)


## 3. Ajax 异步编程